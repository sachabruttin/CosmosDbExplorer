name: Inno
on:
  workflow_dispatch:
    
  # release:
  #   types: [published]

jobs:
  publish:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [amd64, arm64, 386]
    defaults:
      run:
        shell: pwsh
        working-directory: ${{ github.workspace }}/setup/inno
    steps:
    - name: Checkout code 👋
      uses: actions/checkout@v2
    - name: Build installer 📦
      id: build
      run: |
        $version = $env:GITHUB_REF.TrimStart("refs/tags/v")
        ./build.ps1 -Version $version
    - name: Get release ⬇️
      id: get_release
      uses: bruceadams/get-release@v1.2.3
      env:
        GITHUB_TOKEN: ${{ github.token }}
    - name: Upload artifacts 🆙
      uses: actions/github-script@v5
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          console.log('environment', process.versions);

          const fs = require('fs').promises;

          const { repo: { owner, repo }, sha } = context;
          console.log({ owner, repo, sha });

          for (let file of await fs.readdir('./setup/inno/Output')) {
            console.log('uploading', file);

            await github.rest.repos.uploadReleaseAsset({
              owner, repo,
              release_id: ${{ steps.get_release.outputs.id }},
              name: file,
              data: await fs.readFile(`./setup/inno/Output/${file}`)
            });
          }
